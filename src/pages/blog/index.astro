---
import MainLayout from '@/layouts/main.astro';
import { getCollection } from 'astro:content';

// Get all blog posts
const allPosts = await getCollection('blog', ({ data }) => {
	return data.draft !== true;
});

// Sort by date (newest first)
const posts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get unique categories
const categories = [...new Set(posts.map(post => post.data.category).filter(Boolean))];

// Format date helper
const formatDate = (date: Date) => {
	return new Intl.DateTimeFormat('sk-SK', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	}).format(date);
};
---

<MainLayout title="Blog" description="Prečítajte si naše príbehy, tipy a novinky o našich psíkoch a adopciách.">
	<!-- Header Section -->
	<section id="header" class="header-section">
		<div class="mx-auto max-w-screen-2xl px-4 py-16">
			<div class="max-w-4xl mx-auto text-center space-y-4">
				<h1 class="text-4xl md:text-5xl font-bold">Blog</h1>
				<p class="text-xl text-muted-foreground max-w-2xl mx-auto">
					Príbehy našich psíkov, tipy na starostlivosť a novinky z útulku
				</p>
			</div>
		</div>
	</section>

	<!-- Filters Section -->
	<section id="filters" class="filters-section">
		<div class="mx-auto max-w-screen-2xl px-4 py-8">
			<div class="max-w-6xl mx-auto">
				<div class="bg-card border border-border rounded-lg p-6">
					<h2 class="text-xl font-semibold mb-4">Filtrovať články</h2>
					<div class="flex flex-wrap gap-3">
						<button
							class="category-filter px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors"
							data-category="all"
						>
							Všetky
						</button>
						{categories.map((category) => (
							<button
								class="category-filter px-4 py-2 rounded-md bg-secondary text-secondary-foreground hover:bg-secondary/90 transition-colors"
								data-category={category}
							>
								{category}
							</button>
						))}
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- Blog Posts Grid Section -->
	<section id="blog-grid" class="blog-grid-section">
		<div class="mx-auto max-w-screen-2xl px-4 py-16">
			<div id="posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
				{posts.map((post) => (
					<article
						class="blog-card rounded-lg border border-border overflow-hidden bg-card hover:shadow-lg transition-shadow"
						data-category={post.data.category || ''}
					>
						{post.data.image && (
							<img
								src={post.data.image}
								alt={post.data.imageAlt || post.data.title}
								class="w-full h-56 object-cover"
							/>
						)}
						<div class="p-6 space-y-4">
							{post.data.category && (
								<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-primary/10 text-primary">
									{post.data.category}
								</span>
							)}
							<h2 class="text-2xl font-bold line-clamp-2">
								<a href={`/blog/${post.id}`} class="hover:text-primary transition-colors">
									{post.data.title}
								</a>
							</h2>
							<p class="text-sm text-muted-foreground">
								{formatDate(post.data.pubDate)} • {post.data.author}
							</p>
							<p class="text-muted-foreground line-clamp-3">
								{post.data.description}
							</p>
							{post.data.tags && post.data.tags.length > 0 && (
								<div class="flex flex-wrap gap-2">
									{post.data.tags.map((tag) => (
										<span class="text-xs px-2 py-1 rounded bg-muted text-muted-foreground">
											#{tag}
										</span>
									))}
								</div>
							)}
							<a
								href={`/blog/${post.id}`}
								class="inline-block w-full px-4 py-2 text-center rounded-md bg-secondary text-secondary-foreground hover:bg-secondary/90 transition-colors font-semibold"
							>
								Čítať viac
							</a>
						</div>
					</article>
				))}
			</div>
		</div>
	</section>

	<script>
		// Category filtering
		const categoryButtons = document.querySelectorAll('.category-filter');
		const blogCards = document.querySelectorAll('.blog-card');

		function filterByCategory(category: string) {
			let visibleCount = 0;

			blogCards.forEach((card) => {
				const cardElement = card as HTMLElement;
				const cardCategory = cardElement.dataset.category || '';

				if (category === 'all' || cardCategory === category) {
					cardElement.style.display = '';
					visibleCount++;
				} else {
					cardElement.style.display = 'none';
				}
			});

			// Update active button
			categoryButtons.forEach((btn) => {
				const btnElement = btn as HTMLElement;
				if (btnElement.dataset.category === category) {
					btnElement.classList.remove('bg-secondary', 'text-secondary-foreground');
					btnElement.classList.add('bg-primary', 'text-primary-foreground');
				} else {
					btnElement.classList.remove('bg-primary', 'text-primary-foreground');
					btnElement.classList.add('bg-secondary', 'text-secondary-foreground');
				}
			});

			// Show message if no posts
			const container = document.getElementById('posts-container');
			if (container) {
				const existingMessage = container.querySelector('.no-results');
				if (existingMessage) {
					existingMessage.remove();
				}

				if (visibleCount === 0) {
					const message = document.createElement('div');
					message.className = 'no-results col-span-full text-center py-12';
					message.innerHTML = `
						<p class="text-xl text-muted-foreground mb-2">Nenašli sa žiadne články v tejto kategórii.</p>
						<p class="text-muted-foreground">Skúste inú kategóriu.</p>
					`;
					container.appendChild(message);
				}
			}
		}

		// Add click listeners
		categoryButtons.forEach((button) => {
			button.addEventListener('click', () => {
				const category = (button as HTMLElement).dataset.category || 'all';
				filterByCategory(category);
			});
		});
	</script>
</MainLayout>
